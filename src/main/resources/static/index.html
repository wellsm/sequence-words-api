<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>WS Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body { font-family: system-ui, sans-serif; margin: 2rem; }
        input, button { padding: .6rem .8rem; font-size: 1rem; }
        .row { display: flex; gap: .5rem; margin-bottom: .75rem; flex-wrap: wrap; }
        #log { margin-top: 1rem; border: 1px solid #ddd; padding: .75rem; height: 260px; overflow: auto; background: #fafafa; }
        .pill { display:inline-block; padding:.2rem .5rem; border-radius:999px; background:#eee; margin-right:.4rem; }
    </style>
</head>
<body>
<h1>Spring STOMP Broadcast por Código</h1>

<div class="row">
    <span class="pill">Endpoint WS: <code>/ws</code></span>
    <span class="pill">Subscribe: <code>/topic/&lt;code&gt;</code></span>
    <span class="pill">POST: <code>/notify</code></span>
</div>

<div class="row">
    <input id="code" placeholder="code (ex: sala-123)" />
    <button id="connect">Conectar & Inscrever</button>
    <button id="disconnect" disabled>Desconectar</button>
</div>

<div class="row">
    <input id="postMsg" placeholder="mensagem para enviar via POST" style="min-width: 280px;" />
    <button id="send">POST /notify</button>
</div>

<pre id="log"></pre>

<!-- CDN do SockJS e STOMP -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    let stomp, sub;
    const logEl = document.getElementById('log');

    function log(line) {
        const time = new Date().toLocaleTimeString();
        logEl.textContent += `[${time}] ${line}\n`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    document.getElementById('connect').onclick = () => {
        const code = document.getElementById('code').value.trim();
        if (!code) return alert('Informe um code para inscrever.');

        const sock = new SockJS('/ws');
        stomp = Stomp.over(sock);
        stomp.debug = () => {}; // silencioso

        stomp.connect({}, () => {
            log('Conectado.');
            sub = stomp.subscribe(`/topic/${code}`, (msg) => {
                log('Recebido: ' + msg.body);
            });
            document.getElementById('disconnect').disabled = false;
        }, (err) => log('Erro WS: ' + err));
    };

    document.getElementById('disconnect').onclick = () => {
        if (sub) sub.unsubscribe();
        if (stomp) stomp.disconnect(() => log('Desconectado.'));
        document.getElementById('disconnect').disabled = true;
    };

    document.getElementById('send').onclick = async () => {
        const code = document.getElementById('code').value.trim();
        const message = document.getElementById('postMsg').value || 'hello!';
        if (!code) return alert('Informe um code para enviar.');

        const res = await fetch('/notify', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ code, message })
        });
        const json = await res.json();
        log('POST /notify → ' + JSON.stringify(json));
    };
</script>
</body>
</html>
